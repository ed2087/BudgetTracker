<!-- Global Confirmations Modal -->
<div id="confirmationsModal" class="modal hidden">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h3>‚è∞ Pending Confirmations</h3>
      <button class="modal-close" id="closeConfirmationsModal">&times;</button>
    </div>
    <div class="modal-body" id="confirmationsModalBody">
      <div class="confirmations-loading">Loading confirmations...</div>
    </div>
  </div>
</div>

<script>
// Global function to open confirmations modal
window.openConfirmationsModal = async () => {
  const modal = document.getElementById('confirmationsModal');
  const body = document.getElementById('confirmationsModalBody');
  
  if (!modal || !body) return;
  
  // Show modal
  modal.classList.remove('hidden');
  
  // Load confirmations
  try {
    const response = await fetchAPI('/confirmations');
    
    if (response.success) {
      const allConfirmations = [...(response.pending || []), ...(response.snoozed || [])];
      
      if (allConfirmations.length === 0) {
        body.innerHTML = '<p class="empty-state">‚úÖ No pending confirmations! You\'re all caught up.</p>';
        return;
      }
      
      // Separate by type
      const incomeConfirmations = allConfirmations.filter(c => c.type === 'income');
      const expenseConfirmations = allConfirmations.filter(c => c.type === 'expense');
      
      let html = '';
      
      if (incomeConfirmations.length > 0) {
        html += '<h4>üí∞ Income Confirmations</h4>';
        html += '<div class="confirmations-list">';
        incomeConfirmations.forEach(confirmation => {
          html += createIncomeConfirmationHTML(confirmation);
        });
        html += '</div>';
      }
      
      if (expenseConfirmations.length > 0) {
        html += '<h4>üí∏ Expense Confirmations</h4>';
        html += '<div class="confirmations-list">';
        expenseConfirmations.forEach(confirmation => {
          html += createExpenseConfirmationHTML(confirmation);
        });
        html += '</div>';
      }
      
      body.innerHTML = html;
    }
  } catch (error) {
    body.innerHTML = '<p class="error-state">Failed to load confirmations. Please refresh the page.</p>';
    console.error('Failed to load confirmations:', error);
  }
};

// Global function to reload confirmations (called after confirm/skip/snooze)
window.reloadConfirmations = async () => {
  await window.openConfirmationsModal();
  
  // Also reload the notification banner count
  if (typeof window.reloadNotifications === 'function') {
    await window.reloadNotifications(false); // Don't auto-open again
  }
};

function createIncomeConfirmationHTML(confirmation) {
  const now = new Date();
  const dueDate = new Date(confirmation.dueDate);
  const daysOverdue = Math.floor((now - dueDate) / (1000 * 60 * 60 * 24));
  const isOverdue = daysOverdue > 0;
  const isSnoozed = confirmation.status === 'snoozed';
  
  const overdueClass = isOverdue ? 'confirmation-overdue' : '';
  const snoozedClass = isSnoozed ? 'confirmation-snoozed' : '';
  
  let statusBadge = '';
  if (isSnoozed) {
    const snoozeDate = new Date(confirmation.snoozeUntil);
    statusBadge = `<span class="status-badge snoozed-badge">‚è∞ Snoozed until ${formatDate(snoozeDate)}</span>`;
  } else if (isOverdue) {
    statusBadge = `<span class="status-badge overdue-badge">‚ö†Ô∏è ${daysOverdue} day${daysOverdue > 1 ? 's' : ''} overdue</span>`;
  } else {
    statusBadge = `<span class="status-badge today-badge">üìÖ Today</span>`;
  }
  
  return `
    <div class="confirmation-item ${overdueClass} ${snoozedClass}">
      <div class="confirmation-header">
        ${statusBadge}
        <span class="confirmation-date">Due: ${formatDate(dueDate)}</span>
      </div>
      <div class="confirmation-text">
        Did you get paid ${formatCurrency(confirmation.expectedAmount)} from ${confirmation.name}?
      </div>
      <div class="confirmation-actions">
        <button class="btn btn-success btn-sm" onclick="confirmIncome('${confirmation._id}', ${confirmation.expectedAmount})">‚úì YES - Received</button>
        <button class="btn btn-warning btn-sm" onclick="snoozeConfirmation('${confirmation._id}')">‚è∞ NOT YET</button>
        <button class="btn btn-primary btn-sm" onclick="showDifferentAmount('${confirmation._id}', 'income')">üí∞ Different Amount</button>
      </div>
    </div>
  `;
}

function createExpenseConfirmationHTML(confirmation) {
  const now = new Date();
  const dueDate = new Date(confirmation.dueDate);
  const daysOverdue = Math.floor((now - dueDate) / (1000 * 60 * 60 * 24));
  const isOverdue = daysOverdue > 0;
  const isSnoozed = confirmation.status === 'snoozed';
  
  const overdueClass = isOverdue ? 'confirmation-overdue' : '';
  const snoozedClass = isSnoozed ? 'confirmation-snoozed' : '';
  
  let statusBadge = '';
  if (isSnoozed) {
    const snoozeDate = new Date(confirmation.snoozeUntil);
    statusBadge = `<span class="status-badge snoozed-badge">‚è∞ Snoozed until ${formatDate(snoozeDate)}</span>`;
  } else if (isOverdue) {
    statusBadge = `<span class="status-badge overdue-badge">‚ö†Ô∏è ${daysOverdue} day${daysOverdue > 1 ? 's' : ''} overdue</span>`;
  } else {
    statusBadge = `<span class="status-badge today-badge">üìÖ Today</span>`;
  }
  
  return `
    <div class="confirmation-item ${overdueClass} ${snoozedClass}">
      <div class="confirmation-header">
        ${statusBadge}
        <span class="confirmation-date">Due: ${formatDate(dueDate)}</span>
      </div>
      <div class="confirmation-text">
        Is the ${confirmation.name} (${formatCurrency(confirmation.expectedAmount)}) paid this month?
      </div>
      <div class="confirmation-actions">
        <button class="btn btn-success btn-sm" onclick="showExpenseDate('${confirmation._id}')">‚úì YES - Mark Paid</button>
        <button class="btn btn-warning btn-sm" onclick="snoozeConfirmation('${confirmation._id}')">‚è∞ NOT YET</button>
        <button class="btn btn-danger btn-sm" onclick="skipConfirmation('${confirmation._id}')">‚úó SKIP THIS MONTH</button>
      </div>
    </div>
  `;
}

// Close modal functionality
document.addEventListener('DOMContentLoaded', () => {
  const closeBtn = document.getElementById('closeConfirmationsModal');
  const modal = document.getElementById('confirmationsModal');
  
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      modal?.classList.add('hidden');
    });
  }
  
  // Close on background click
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target.id === 'confirmationsModal') {
        modal.classList.add('hidden');
      }
    });
  }
  
  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      modal?.classList.add('hidden');
    }
  });
});
</script>